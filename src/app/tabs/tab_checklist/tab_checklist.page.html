<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button class="header-button" routerLink="/tabs/tab-dashboard">
        <ion-icon slot="start" name="arrow-back"></ion-icon>
        Dashboard
      </ion-button>
    </ion-buttons>
    <ion-title class="centered-title">Relocation Plan</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="presentFilterPopover($event)" [disabled]="isGeneratingChecklist || !isQuestionnaireFilled">
        <ion-icon slot="icon-only" name="filter-outline" [color]="activeFiltersCount > 0 ? 'warning' : ''"></ion-icon>
      </ion-button>
      <ion-button (click)="regenerateChecklist()" [disabled]="isGeneratingChecklist || !isQuestionnaireFilled">
        <ion-icon slot="icon-only" name="refresh-outline"></ion-icon>
      </ion-button>
      <app-account-button></app-account-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar>
    <ion-searchbar [(ngModel)]="searchTerm" (ionInput)="onSearchInput($event)" placeholder="Search tasks or notes..."
      [disabled]="isGeneratingChecklist || !isQuestionnaireFilled" debounce="300"></ion-searchbar>
  </ion-toolbar>

  <ion-toolbar>
    <ion-segment [(ngModel)]="selectedStage" (ionChange)="handleStageChange()">
      <ion-segment-button value="predeparture" 
                         [class.segment-generating]="isGeneratingChecklist && workingOnStage === 'predeparture'">
        <ion-label>
          Predeparture
          <span class="task-badge" 
                [class.generating-badge]="isGeneratingChecklist && (workingOnStage === 'predeparture' || workingOnStage === 'preparing')"
                [class.completed-badge]="!isGeneratingChecklist && isStageCompleted('predeparture')">
                {{ !isGeneratingChecklist ? getCompletedTasksCountForStage('predeparture') : 
                   (workingOnStage === 'preparing' || !stagesWithTotalsRendered.has('predeparture')) ? '0' :
                   getGeneratedTasksCountForStage('predeparture') }}/{{ getTotalTasksForStage('predeparture') }}
          </span>
        </ion-label>
      </ion-segment-button>
      <ion-segment-button value="departure"
                         [class.segment-generating]="isGeneratingChecklist && workingOnStage === 'departure'">
        <ion-label>
          Departure
          <span class="task-badge" 
                [class.generating-badge]="isGeneratingChecklist && (workingOnStage === 'departure' || workingOnStage === 'preparing')"
                [class.completed-badge]="!isGeneratingChecklist && isStageCompleted('departure')">
            {{ !isGeneratingChecklist ? getCompletedTasksCountForStage('departure') : 
               (workingOnStage === 'preparing' || !stagesWithTotalsRendered.has('departure')) ? '0' :
               getGeneratedTasksCountForStage('departure') }}/{{ getTotalTasksForStage('departure') }}
          </span>
        </ion-label>
      </ion-segment-button>
      <ion-segment-button value="arrival"
                         [class.segment-generating]="isGeneratingChecklist && workingOnStage === 'arrival'">
        <ion-label>
          Arrival
          <span class="task-badge" 
                [class.generating-badge]="isGeneratingChecklist && (workingOnStage === 'arrival' || workingOnStage === 'preparing')"
                [class.completed-badge]="!isGeneratingChecklist && isStageCompleted('arrival')">
            {{ !isGeneratingChecklist ? getCompletedTasksCountForStage('arrival') : 
               (workingOnStage === 'preparing' || !stagesWithTotalsRendered.has('arrival')) ? '0' :
               getGeneratedTasksCountForStage('arrival') }}/{{ getTotalTasksForStage('arrival') }}
          </span>
        </ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>

  <!-- Progress toolbar - always visible when questionnaire is filled -->
  <ion-toolbar *ngIf="(isQuestionnaireFilled && totalTasksToGenerate > 0) || isGeneratingChecklist" class="generation-status-toolbar">
    <div class="ion-padding-horizontal">
      <!-- Preparing phase header -->
      <div *ngIf="isGeneratingChecklist && workingOnStage === 'preparing'" class="generation-status-header">
        <ion-icon name="hourglass-outline" color="tertiary"></ion-icon>
        <span>Preparing task structure</span>
      </div>
      
      <!-- Active generation phase header -->
      <div *ngIf="isGeneratingChecklist && workingOnStage !== 'preparing'" class="generation-status-header">
        <ion-icon name="flash-outline" color="primary"></ion-icon>
        <span>
          Working on <strong>{{ workingOnStage | titlecase }}</strong> tasks
          <span class="task-count-badge">{{ getGeneratedTasksCountForStage(workingOnStage) }}/{{ getTotalTasksForStage(workingOnStage) }}</span>
        </span>
      </div>
      
      <!-- Task completion phase header when not generating -->
      <div *ngIf="!isGeneratingChecklist && totalTasksToGenerate > 0" class="generation-status-header">
        <ion-icon name="checkbox-outline" color="success"></ion-icon>
        <span>Track your progress for each stage</span>
      </div>
      
      <!-- Structure preparation progress bar with improved styling -->
      <ion-progress-bar *ngIf="isGeneratingChecklist && workingOnStage === 'preparing'"
        class="stage-progress-bar preparing-progress-bar preparing-progress"
        [value]="preparingProgress"
        color="tertiary">
      </ion-progress-bar>
      
      <!-- Stage progress information while still in preparing phase -->
      <div *ngIf="isGeneratingChecklist && workingOnStage === 'preparing' && initialStructureReceived" class="ion-padding-top ion-text-center">
        <small>Preparing {{ totalTasksToGenerate }} tasks across all stages</small>
      </div>
      
      <!-- Always show stage progress, in both generating and completion phases -->
      <div *ngIf="(stagesWithTotalsRendered.size > 0 || workingOnStage !== 'preparing' || !isGeneratingChecklist) && totalTasksToGenerate > 0">
        <!-- Current stage progress -->
        <div [ngSwitch]="selectedStage">
          <!-- Predeparture progress -->
          <div *ngSwitchCase="'predeparture'" class="active-stage-progress">
            <div class="stage-progress-header">
              <span class="stage-name">Predeparture Progress</span>
              <span class="stage-counts" [class.generating-badge]="isGeneratingChecklist">
                {{ isGeneratingChecklist ? 
                   (workingOnStage === 'preparing' || !stagesWithTotalsRendered.has('predeparture')) ? '0' : getGeneratedTasksCountForStage('predeparture') : 
                   getCompletedTasksCountForStage('predeparture') }}/{{ getTotalTasksForStage('predeparture') }}
              </span>
              <ion-icon *ngIf="isStageCompleted('predeparture')" name="checkmark-circle" color="success"></ion-icon>
            </div>
            <ion-progress-bar 
              [value]="getStageProgressValue('predeparture')" 
              [color]="getStageProgressColor('predeparture')"
              class="stage-progress-bar"
              [class.draining]="isDraining">
            </ion-progress-bar>
          </div>
          
          <!-- Departure progress -->
          <div *ngSwitchCase="'departure'" class="active-stage-progress">
            <div class="stage-progress-header">
              <span class="stage-name">Departure Progress</span>
              <span class="stage-counts" [class.generating-badge]="isGeneratingChecklist">
                {{ isGeneratingChecklist ? 
                   (workingOnStage === 'preparing' || !stagesWithTotalsRendered.has('departure')) ? '0' : getGeneratedTasksCountForStage('departure') : 
                   getCompletedTasksCountForStage('departure') }}/{{ getTotalTasksForStage('departure') }}
              </span>
              <ion-icon *ngIf="isStageCompleted('departure')" name="checkmark-circle" color="success"></ion-icon>
            </div>
            <ion-progress-bar 
              [value]="getStageProgressValue('departure')" 
              [color]="getStageProgressColor('departure')"
              class="stage-progress-bar"
              [class.draining]="isDraining">
            </ion-progress-bar>
          </div>
          
          <!-- Arrival progress -->
          <div *ngSwitchCase="'arrival'" class="active-stage-progress">
            <div class="stage-progress-header">
              <span class="stage-name">Arrival Progress</span>
              <span class="stage-counts" [class.generating-badge]="isGeneratingChecklist">
                {{ isGeneratingChecklist ? 
                   (workingOnStage === 'preparing' || !stagesWithTotalsRendered.has('arrival')) ? '0' : getGeneratedTasksCountForStage('arrival') : 
                   getCompletedTasksCountForStage('arrival') }}/{{ getTotalTasksForStage('arrival') }}
              </span>
              <ion-icon *ngIf="isStageCompleted('arrival')" name="checkmark-circle" color="success"></ion-icon>
            </div>
            <ion-progress-bar 
              [value]="getStageProgressValue('arrival')" 
              [color]="getStageProgressColor('arrival')"
              class="stage-progress-bar"
              [class.draining]="isDraining">
            </ion-progress-bar>
          </div>
        </div>
      </div>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="false" class="checklist-content">
  <div *ngIf="!isQuestionnaireFilled && !isGeneratingChecklist" class="ion-padding ion-text-center empty-list-message">
    <ion-icon name="document-text-outline" size="large" color="medium"></ion-icon>
    <p>Your personalized relocation checklist will appear here.</p>
    <ion-button routerLink="/tabs/tab_quiz" routerDirection="root" fill="clear">
      Fill out the Questionnaire
    </ion-button>
  </div>

  <div [hidden]="!isQuestionnaireFilled">
    <div *ngFor="let stageKey of ['predeparture', 'departure', 'arrival']" [id]="stageKey"
      [hidden]="selectedStage !== stageKey">
      <ion-list *ngIf="getDisplayedCategoriesForStage(stageKey).length > 0" lines="none">
        <ion-list-header class="stage-list-header">
          <ion-label>
            {{ getTotalDisplayedTasksForStage(stageKey) }}
            {{ stageKey | titlecase }} Tasks
          </ion-label>
          <div class="sort-buttons-container">
            <ion-button fill="clear" size="small" (click)="sortTasks('priority')" [class.active-sort]="currentSort === 'priority'">
                <ion-icon name="list-outline" slot="start"></ion-icon> Priority
            </ion-button>
            <ion-button fill="clear" size="small" (click)="sortTasks('dueDate')" [class.active-sort]="currentSort === 'dueDate'">
                <ion-icon name="time-outline" slot="start"></ion-icon> Due Date
            </ion-button>
          </div>
        </ion-list-header>

        <ng-container *ngFor="let category of getDisplayedCategoriesForStage(stageKey)">
          <ion-item button detail="false" (click)="toggleCategory(category)" class="category-item"
            [class.expanded]="category.isExpanded" [class.category-complete]="areAllTasksComplete(category)"
            [class.newly-created]="category.isNewlyCreated">
            <ion-label>
              <h2>
                {{ category.name | titlecase }}
                <span class="task-count">({{ category.tasks.length }})</span>
                <ion-icon *ngIf="areAllTasksComplete(category)" name="checkmark-circle" color="success"
                  class="category-complete-icon"></ion-icon>
              </h2>
            </ion-label>
            <ion-icon slot="end"
              [name]="category.isExpanded ? 'chevron-down-outline' : 'chevron-forward-outline'"></ion-icon>
          </ion-item>

          <div *ngIf="category.isExpanded" class="task-items-container">
            <ion-list lines="none">
              <ion-item *ngFor="let item of category.tasks; trackBy: trackByTaskId"
                (click)="handleTaskItemClick(item, $event)"
                (dblclick)="handleTaskItemDoubleClick(item, stageKey, category.name, $event)"
                class="task-item"
                [class.is-favorite]="item.isImportant"
                [class.high-priority-incomplete]="item.priority === 'High' && !item.completed"
                [class.newly-generated]="item.isNewlyGenerated">

              <ion-checkbox slot="start" class="task-checkbox" [(ngModel)]="item.completed" 
                (ionChange)="markCheck(item, stageKey, category.name); $event.stopPropagation()">
              </ion-checkbox>

              <ion-label class="task-label">
                <h3 [class.checked]="item.completed">
                  <ion-icon *ngIf="item.isImportant" name="star" color="warning" class="favorite-star-inline"></ion-icon>
                  {{ item.task_description }}
                </h3>
                <p class="task-meta">
                  <span class="priority-indicator" [class.high-priority]="item.priority === 'High'"
                    [class.medium-priority]="item.priority === 'Medium'"
                    [class.low-priority]="item.priority === 'Low'">
                    <ion-icon [name]="getPriorityIcon(item.priority)" class="priority-icon"></ion-icon>
                    {{ item.priority }}
                  </span>
                  
                  <span class="due-date-indicator">
                    <ion-icon name="calendar-outline" class="due-date-icon"></ion-icon>
                    Due:
                    <ng-container *ngIf="item.due_date">
                      <ng-container *ngIf="isAbsoluteDate(item.due_date); else showRelativeFormattedStringForNonAbsolute">
                        {{ formatDateWithOrdinal(item.due_date) }}
                        <span *ngIf="getRelativeDueDate(item.due_date) as relativeDue" class="relative-due-date">
                          <ng-container *ngIf="relativeDue && (relativeDue !== formatDateWithOrdinal(item.due_date))">
                            ({{ relativeDue }})
                          </ng-container>
                        </span>
                      </ng-container>
                      <ng-template #showRelativeFormattedStringForNonAbsolute>
                        {{ getRelativeDueDate(item.due_date) }}
                      </ng-template>
                    </ng-container>
                    <ng-container *ngIf="!item.due_date">
                      N/A
                    </ng-container>
                  </span>
                </p>
                <!-- Brief notes preview, if any -->
                <p *ngIf="item.notes && item.notes.length > 0" class="task-notes-preview">
                    <ion-icon name="document-text-outline"></ion-icon> {{ item.notes | slice:0:50 }}{{ item.notes.length > 50 ? '...' : ''}}
                </p>
              </ion-label>

              <ion-buttons slot="end" class="task-actions-end">
                <!-- The click handler for opening the modal already has $event.stopPropagation() -->
                <ion-button fill="clear" color="medium" (click)="openDetailedTaskModal(item); $event.stopPropagation()" class="info-button">
                  <ion-icon slot="icon-only" name="ellipsis-horizontal"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-item>
            </ion-list>
          </div>
        </ng-container>
      </ion-list>

      <div *ngIf="getDisplayedCategoriesForStage(stageKey).length === 0 && isQuestionnaireFilled && !isGeneratingChecklist"
        class="ion-padding ion-text-center empty-list-message">
        <ion-icon name="search-outline" size="large" color="medium"></ion-icon>
        <p>No {{ stageKey | titlecase }} tasks match your current filters or search.</p>
         <ion-button fill="clear" (click)="resetFiltersAndSearch()">Reset Filters</ion-button>
      </div>
    </div>
  </div>

  <ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="isQuestionnaireFilled && !isGeneratingChecklist">
    <ion-fab-button (click)="openAddTaskModal()">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

</ion-content>

<ion-footer *ngIf="isQuestionnaireFilled && !isGeneratingChecklist && totalTasksToGenerate > 0" class="ion-no-border">
  <ion-toolbar>
    <div class="overall-progress-container ion-padding">
      <div class="overall-progress-info">
        <span class="progress-label">Task Completion</span>
        <span class="progress-count">{{ totalCompletedTasks }} / {{ totalTasksToGenerate }}</span>
      </div>
      <ion-progress-bar [value]="totalTasksToGenerate > 0 ? totalCompletedTasks / totalTasksToGenerate : 0"
        color="success" class="overall-progress-bar" [class.draining]="isDraining"></ion-progress-bar>
    </div>
  </ion-toolbar>
</ion-footer>

<ion-footer *ngIf="isGeneratingChecklist" class="ion-no-border generation-footer">
  <ion-toolbar>
     <div class="overall-progress-container ion-padding">
        <div class="overall-progress-info">
          <span class="progress-label" *ngIf="totalTasksToGenerate > 0">
            {{ workingOnStage === 'preparing' ? 'Preparing' : 'Generating Tasks' }}
          </span>
          <span class="progress-count" *ngIf="totalTasksToGenerate > 0">
            {{ generatedTasksCount }} / {{ totalTasksToGenerate }}
          </span>
        </div>
        
        <!-- Overall progress bar with dynamic styling -->
        <ion-progress-bar
          class="overall-progress-bar"
          [value]="totalTasksToGenerate > 0 ? generatedTasksCount / totalTasksToGenerate : preparingProgress" 
          [color]="workingOnStage === 'preparing' ? 'tertiary' : 'primary'">
        </ion-progress-bar>
     </div>
  </ion-toolbar>
</ion-footer>
